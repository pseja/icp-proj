<automaton name="TOF">
    <comment>Timer to off, umí nastavit timeout a na požádání sdělit zbývající čas timeru.</comment>
    <inputs>
        <input name="in"/>
        <input name="set_to"/>
        <input name="req_rt"/>
    </inputs>
    <outputs>
        <output name="out"/>
        <output name="rt"/>
    </outputs>
    <variables>
        <variable name="timeout" type="int" value="5000"/>
    </variables>
    <states>
        <state name="IDLE" initial="true">
            <code>if (defined("set_to")) {timeout = Qtoi(valueof("set_to"));output("out", 0);output("rt", 0);}</code>
            <code><![CDATA[if (defined("set_to")) { timeout = atoi(valueof("set_to"));output("out", 0);output("rt", 0); }]]></code>
        </state>
        <state name="ACTIVE">
            <code>if (defined("set_to")) {timeout = Qtoi(valueof("set_to"));output("out", 1);output("rt", timeout);}</code>
            <code><![CDATA[if (defined("set_to")) { timeout = atoi(valueof("set_to"));output("out", 1);output("rt", timeout); } ]]></code>
        </state>
        <state name="TIMING">
            <code>if (defined("set_to")) {timeout = Qtoi(valueof("set_to"));output("rt", (timeout - elapsed()));}</code>
            <code><![CDATA[if (defined("set_to")) { timeout = atoi(valueof("set_to"));output("rt", timeout - elapsed()); } ]]></code>
        </state>
    </states>
    <transitions>
        <transition from="IDLE" to="ACTIVE">
            <condition event="in">Qtoi(valueof("in")) == 1</condition>
            <condition event="in"><![CDATA[atoi(valueof("in")) == 1]]></condition>
        </transition>
        <transition from="ACTIVE" to="TIMING">
            <condition event="in">Qtoi(valueof("in")) == 0</condition>
            <condition event="in"><![CDATA[atoi(valueof("in")) == 0]]></condition>
        </transition>
        <transition from="TIMING" to="ACTIVE">
            <condition event="in">Qtoi(valueof("in")) == 1</condition>
            <condition event="in"><![CDATA[atoi(valueof("in")) == 1]]></condition>
        </transition>
        <transition from="TIMING" to="IDLE">
            <delay>timeout</delay>
        </transition>
        <transition from="IDLE" to="IDLE">
            <condition event="set_to"/>
        </transition>
        <transition from="ACTIVE" to="ACTIVE">
            <condition event="set_to"/>
        </transition>
        <transition from="TIMING" to="TIMING">
            <condition event="set_to"/>
        </transition>
        <transition from="IDLE" to="IDLE">
            <condition event="req_rt"/>
        </transition>
        <transition from="ACTIVE" to="ACTIVE">
            <condition event="req_rt"/>
        </transition>
        <transition from="TIMING" to="TIMING">
            <condition event="req_rt"/>
        </transition>
    </transitions>
</automaton>
